---
import { getImage } from "astro:assets";

let {
  src,
  aspect,
  attributes,
  sizes = "100vw",
  alt = "my image",
  width = 640,
  height = 640,
  loading = "lazy",
  widths = [
    240, 320, 400, 450, 480, 580, 640, 750, 828, 940, 990, 1080, 1200, 1450, 1920,
  ],
  artDirectives = [],
  layout = "fill",
  mobileSize = null, // ðŸ”¥ suporte para tamanho mobile
} = Astro.props;

// ðŸ”¥ aplica mobileSize apenas no mobile
if (mobileSize) {
  sizes = `(max-width: 767px) ${mobileSize}, ${sizes}`;
}

const allImages = import.meta.glob("/src/assets/*.{jpeg,jpg,png,gif}");
const imgObj = (await allImages[src]()).default;

if (aspect) height = Math.round(width / aspect);

const image = await getImage({
  src: imgObj,
  width,
  height,
  aspect,
  format: imgObj.format,
});

const formats = ["webp"];

const sources = await Promise.all(
  formats.map(async (format) => {
    const img = await getImage({
      src: imgObj,
      format,
      width,
      height,
      widths,
      sizes,
      aspect,
    });

    return {
      format,
      srcset: img.srcSet.attribute,
    };
  }),
);

// art direction
const artdirection = await Promise.all(
  artDirectives.map(async (directive) =>
    Promise.all(
      formats.map(async (format) => {
        const img = await getImage({
          src: imgObj,
          format,
          width,
          height,
          aspect: directive.aspect,
          widths: directive.breakpoints,
        });

        return {
          format,
          srcset: img.srcSet.attribute,
          media: directive.media,
        };
      }),
    ),
  ),
);

function imgClass() {
  if (layout === "fill") return "w-full h-full object-cover";
  if (layout === "fullWidth") return "w-full h-auto object-cover";
  if (layout === "contain") return "w-full h-full object-contain";
}
---

<picture {...attributes?.picture}>
  {
    artdirection.map((directive) => (
      <>
        {directive.map((source) => (
          <source
            type={`image/${source.format}`}
            srcset={source.srcset}
            sizes={sizes}
            media={source.media}
          />
        ))}
      </>
    ))
  }

  {
    sources.map((source) => (
      <source
        type={`image/${source.format}`}
        srcset={source.srcset}
        sizes={sizes}
      />
    ))
  }

  <img
    src={image.src}
    alt={alt}
    class={imgClass()}
    sizes={sizes}
    width={width}
    height={height}
    loading={loading}
    {...attributes?.img}
  />
</picture>
